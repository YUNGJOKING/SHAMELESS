<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHAMELESS - Live Chat + VC</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #121014;
      color: #ddd;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: #1e0e3f;
      padding: 15px 20px;
      text-align: center;
      font-size: 32px;
      font-weight: 900;
      color: #bb86fc;
      letter-spacing: 4px;
      user-select: none;
      box-shadow: 0 0 15px #7a2cf4aa;
      font-family: 'Segoe UI Black', Tahoma, Geneva, Verdana, sans-serif;
      flex-shrink: 0;
    }
    #main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      height: calc(100vh - 70px);
      user-select: text;
    }
    #chat {
      width: 320px;
      background: #1e0e3f;
      padding: 15px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 15px #7a2cf4aa;
      overflow: hidden;
    }
    #chat h3 {
      margin: 0 0 15px 0;
      color: #bb86fc;
      user-select: none;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #7a2cf4;
      border-radius: 8px;
      padding: 10px;
      background: #290f63;
      color: #eee;
      font-size: 14px;
      line-height: 1.3;
    }
    #messages div {
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    #msg {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      outline: none;
      background: #2a1365;
      color: #eee;
      width: 100%;
      box-sizing: border-box;
    }
    #msg::placeholder {
      color: #aaa;
    }
    button {
      margin-top: 8px;
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #7a2cf4;
      color: white;
      transition: background 0.3s ease;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
    }
    button:hover:not(:disabled) {
      background: #a16eff;
    }
    button:disabled {
      background: #5a1ecc;
      cursor: not-allowed;
    }
    #video-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0c071a;
      padding: 10px;
      box-shadow: inset 0 0 25px #7a2cf4bb;
      overflow: hidden;
    }
    #controls {
      padding: 10px 0;
      text-align: center;
      flex-shrink: 0;
    }
    #video-grid {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      overflow-y: auto;
    }
    video {
      width: 300px;
      max-height: 200px;
      border-radius: 12px;
      background: black;
      box-shadow: 0 0 10px #7a2cf4bb;
      object-fit: cover;
      user-select: none;
    }

    /* Username modal overlay */
    #username-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(18, 16, 20, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      color: #ddd;
      user-select: none;
    }
    #username-modal h2 {
      margin-bottom: 20px;
      font-weight: 900;
      color: #bb86fc;
      letter-spacing: 2px;
    }
    #username-modal input {
      padding: 10px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      outline: none;
      width: 280px;
      margin-bottom: 15px;
      background: #290f63;
      color: #eee;
      text-align: center;
      user-select: text;
    }
    #username-modal button {
      width: 280px;
    }
  </style>
</head>
<body>
  <header>SHAMELESS</header>

  <div id="username-modal">
    <h2>Enter Your Username</h2>
    <input id="username-input" placeholder="Username" autocomplete="off" />
    <button id="join-btn" disabled>Join Chat</button>
  </div>

  <div id="main-content" style="display:none;">
    <div id="chat">
      <h3>Live Chat</h3>
      <div id="messages"></div>
      <input id="msg" placeholder="Type a message..." autocomplete="off" disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>

    <div id="video-section">
      <div id="controls">
        <button id="vcBtn" disabled>Join Voice/Video Chat</button>
        <button id="screenBtn" disabled>Share Screen</button>
      </div>
      <div id="video-grid"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // DOM references
    const usernameModal = document.getElementById('username-modal');
    const usernameInput = document.getElementById('username-input');
    const joinBtn = document.getElementById('join-btn');
    const mainContent = document.getElementById('main-content');

    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const vcBtn = document.getElementById("vcBtn");
    const screenBtn = document.getElementById("screenBtn");
    const messages = document.getElementById("messages");
    const videoGrid = document.getElementById("video-grid");

    let username = "";
    let joinedVC = false;
    let localStream = null;
    let peers = {};

    // Enable Join button if input has valid username (3+ chars, no spaces)
    usernameInput.addEventListener('input', () => {
      const val = usernameInput.value.trim();
      joinBtn.disabled = !(val.length >= 3 && !/\s/.test(val));
    });

    // On clicking Join Chat
    joinBtn.addEventListener('click', () => {
      username = usernameInput.value.trim();
      if (!username) return;

      // Hide modal, show main UI
      usernameModal.style.display = 'none';
      mainContent.style.display = 'flex';

      // Enable chat inputs and buttons
      msgInput.disabled = false;
      sendBtn.disabled = false;
      vcBtn.disabled = false;

      // Tell server username
      socket.emit("set-username", username);
      addMessage(`You joined as "${username}".`);
    });

    // Chat events and UI
    socket.on("user-joined", (name) => {
      if (name !== username) addMessage(`${name} joined.`);
    });
    socket.on("chat-message", ({ username: user, message }) => addMessage(`${user}: ${message}`));
    socket.on("user-left", (name) => addMessage(`${name} left.`));

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const msg = msgInput.value.trim();
      if (!msg) return;
      socket.emit("chat-message", msg);
      msgInput.value = "";
    }

    function addMessage(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // === WebRTC Voice/Video ===

    vcBtn.onclick = toggleVC;

    async function toggleVC() {
      if (!joinedVC) {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          addVideo(localStream, true);
          socket.emit("join-vc");
          joinedVC = true;
          vcBtn.textContent = "Disconnect VC";
          screenBtn.disabled = false;
        } catch (err) {
          alert("Could not access camera/microphone.");
          console.error(err);
        }
      } else {
        disconnectVC();
      }
    }

    function disconnectVC() {
      for (let id in peers) {
        peers[id].close();
        delete peers[id];
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      videoGrid.innerHTML = "";
      joinedVC = false;
      vcBtn.textContent = "Join Voice/Video Chat";
      screenBtn.disabled = true;
    }

    function addVideo(stream, self = false) {
      const video = document.createElement("video");
      video.srcObject = stream;
      video.autoplay = true;
      video.muted = self;
      video.playsInline = true;
      videoGrid.appendChild(video);
    }

    socket.on("new-peer", async (id) => {
      if (!joinedVC) return;
      const pc = createPeerConnection(id);
      peers[id] = pc;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("signal", { to: id, signal: { sdp: offer } });
    });

    socket.on("signal", async ({ from, signal }) => {
      if (!joinedVC) return;
      if (!peers[from]) {
        const pc = createPeerConnection(from);
        peers[from] = pc;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }
      const pc = peers[from];
      if (signal.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
        if (signal.sdp.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit("signal", { to: from, signal: { sdp: answer } });
        }
      } else if (signal.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
      }
    });

    function createPeerConnection(id) {
      const pc = new RTCPeerConnection();

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("signal", { to: id, signal: { candidate: e.candidate } });
        }
      };

      pc.ontrack = (e) => {
        addVideo(e.streams[0]);
      };

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === "disconnected" || pc.connectionState === "failed" || pc.connectionState === "closed") {
          if (peers[id]) {
            delete peers[id];
          }
        }
      };

      return pc;
    }

    // Screen sharing
    async function shareScreen() {
      if (!joinedVC) return alert("Join VC first to share screen.");
      try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const screenTrack = screenStream.getVideoTracks()[0];
        for (let id in peers) {
          const sender = peers[id].getSenders().find(s => s.track.kind === "video");
          if (sender) await sender.replaceTrack(screenTrack);
        }
        if (videoGrid.lastChild) videoGrid.removeChild(videoGrid.lastChild);
        addVideo(screenStream, true);
        screenTrack.onended = () => {
          if (!localStream) return;
          for (let id in peers) {
            const sender = peers[id].getSenders().find(s => s.track.kind === "video");
            if (sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
          }
          if (videoGrid.lastChild) videoGrid.removeChild(videoGrid.lastChild);
          addVideo(localStream, true);
        };
      } catch (err) {
        alert("Screen sharing failed or was canceled.");
        console.error(err);
      }
    }

    document.getElementById('screenBtn').onclick = shareScreen;

  </script>
</body>
</html>
